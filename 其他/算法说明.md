[TOC]

## 使用说明

- 支持版本：MATLAB_R2018a及以上
- 文件编码：UTF-8
- y值对应的精度为相对精度
- 时间精度取三位小数
- 面积所占百分比支持四位小数
- 默认遍历查找范围 $[0,1]$

### 图像文件说明

- `Unprocessed.png` 原始数据分布

- `Distribution.png`  遍历计算出时间宽度随面积的变化
- `result.png` 选定y值后得出截取的IRF分布

## 计算过程

![](https://tva1.sinaimg.cn/large/006tNbRwly1ga7ronj9mhj30rg0m2t8q.jpg)

### 积分：直接把y的值都加起来

总的值73.5163

```matlab
for i=(1:4093)
are0=are0+y(i);
end
```

```matlab
for i=(sec(2):sec(1))
are1=are1+y(i);
end
```

```matlab
ar=[1:51];
label=[970:1020];
for i=[970:1020]
sec(2)=middle+i;
sec(1)=middle-i;
ar(i-969)=0;
for j=(sec(1):sec(2))
ar(i-969)=ar(i-969)+y(j);
end
end
plot(label,ar)
```

### 调整合适的精度 算法1

基本思想：把所有满足`abs(y(i)-derive) < 0.0005`的数据的下标存储在`sec`数组中

`derive`即为我们指定的y值。(最好直接取一个数据中已有的y值)。

`sec(k)`存储所有y值在指定精度范围内约等于`derive`的数据下标，该数组不定长。

```matlab
%%%%%%%%  设定特定的y  %%%%%%%%
% 参数
derive=0.006;%指定的y值

% 计算对应的x区间
sec=[]; %保存所有满足条件的数据下标
k=0;% 下标
i=1;
while(i<=4093)
    if abs(y(i)-derive) < 0.0005 % 调整精度        
        k=k+1;
        sec(k)=i;
        if(i<middle)
            i=middle;
        end
        %i=i+100;
    end
    i=i+1;
end

```

**好的数据是：k仅仅为2，即只对应了两组数据的y值**

- **零点左侧有较坏的数据：**`if(i<middle)	i=middle;`是指在零点左侧，找到第一个精度范围内y值等于`derive`的数据，下一个就从零点右侧开始找，保证了`derive`的精度基本只和零点左侧数据相关

  - 如果sec数组中所有数据都在零点右侧(其数据下标都大于零点下标)，说明**`derive`正好取到了一个零点左侧没有精度范围内y值的点，但零点右侧有很多**

  - 此时将`derive`调大一点，观察附近值对应的零点左侧的数据

  - 例如

  - ```
    "取y=0.006000
         交点坐标(-36.24,0.005690)(61.48,0.006320)
         与总面积的比值0.981633"
    
        "数据序号为2616和2856"
    
        "y值为0.00569和0.00632"
    
        "概率为0.98163的时间宽度为97.722ps"
    ```

    可见现在取的两个数据对应的y值，再判断合适的`derive`应该在0.00569附近

- **零点右侧有较坏的数据：**一般情况即`k==0`或者`k>>2`时调整`if abs(y(i)-derive) < 0.0005`的精度范围，直至找出`k==2`的情况；如果零点右侧有较坏的数据，说明**`derive`正好取到了一个零点右侧没有精度范围内y值的点**，修改`derive`的值重新判断


### 指定精度后遍历查找 算法2

#### **基本思想**	

将y值从0到1，按0.001的步长，一个一个地遍历查找，按指定相对精度计算对应一个一个的面积占比。

- 每条$y=y_0$直线与IRF分布曲线将有两交点
- 图中横坐标为这两点面积占总面积之比，纵坐标为这两点的时间宽度
- 显然y值越小，两交点的时间宽度越大，对应的面积越大。

![Distribution](/Users/biu/Documents/biu/OneDrive - mail.ustc.edu.cn/qkd/IRF计算/32739.txt-99.00%/Distribution.png)

由分布图可看出

该曲线**斜率越大**，说明该面积所占百分比处，时间宽度变化太快，**误差可能超出实验精度**。

遍历的同时进行查找，在指定相对精度下取离0.99最近的那组数据，用它计算时间宽度，为最后结论。

#### **按指定相对精度计算面积占比**	

这里指定相对精度是指确定一个y值后，如何在离散的数据中得出约等于y值的点。

我们指定相对精度的变量为`derive`

```matlab
if abs(y(i)-ytmp) < ytmp*derive  
```

`y(i)`为当前判断的值，`ytmp`为当前我们遍历到的y值，当它们的差的绝对值小于相对精度时，我们认为此时`y(i)`约等于`ytmp`。

我们将所有满足条件的`y(i)`存储在`sectmp`数组中，**左右各取一个最靠近零点的点**，作为两组用来计算时间宽度的点。

```matlab
% 左右各取一个最靠近零点的点sec(1)和sec(2)
sec=[0,0];
for i=(1:k)
    if sectmp(i)<middle
        if sec(1)<sectmp(i)
            sec(1)=sectmp(i);
        end
    else
        if sec(2)<sectmp(i)
            sec(2)=sectmp(i);
        end
    end
end
```

